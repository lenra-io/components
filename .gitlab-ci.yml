include:
    - project: 'lenra/environment'
      ref: master
      file: '/ci-cd/gitlab/lib/base.yml'
    - project: 'lenra/environment'
      ref: master
      file: '/ci-cd/gitlab/lib/docker.yml'

# Cache for server and client
cache:
    paths:
        - ./server/deps
        - ./server/_build
        - ./client/build

variables:
    CLIENT_WORKDIR: ./client
    SERVER_WORKDIR: ./server

################
## INIT STAGE ##
################

# Handle version globally for server and client

manage version:
    variables:
        VERSION_GETTER: cat version
    extends: .get version


#################
## BUILD STAGE ##
#################
client build prod:
    image: registry.gitlab.com/lenra/integration/docker-ci-flutter
    stage: build 
    script:
        - cd $CLIENT_WORKDIR
        - flutter pub get
        - flutter build web --release --target=./lib/main_prod.dart
    only:
        refs:
            - master

client build dev:
    image: registry.gitlab.com/lenra/integration/docker-ci-flutter
    stage: build
    script:
        - cd $CLIENT_WORKDIR
        - flutter pub get
        - flutter build web --release --target=./lib/main.dart
    except:
        refs:
            - master

server build:
    image: registry.gitlab.com/lenra/integration/docker-ci-elixir
    stage: build
    script:
        - cd $SERVER_WORKDIR
        - mix deps.get
        - mix compile

################
## TEST STAGE ##
################

# Unit test and code analysis for server
server tests:
    image: registry.gitlab.com/lenra/integration/docker-ci-elixir
    services: 
        - postgres:12.2-alpine
    variables:
        POSTGRES_PASSWORD: "postgres"
        POSTGRES_HOST: "postgres"
    stage: test
    script:
        - cd $SERVER_WORKDIR
        - mix deps.get
        - mix credo --strict
        - mix test

###################
## RELEASE STAGE ##
###################
.docker-server-env: &docker-server-env
    stage: release
    variables:
        WORKDIR: $SERVER_WORKDIR
        DOCKER_IMAGE: $CI_REGISTRY_IMAGE/server
        DOCKER_BUILD_ARGS: --build-arg secret_key_base=$SECRET_KEY_BASE


server dockerize:
    <<: *docker-server-env
    extends: .build docker
    only:
        refs:
            - master
            - staging

server dockerize dev:
    <<: *docker-server-env
    extends: .build docker dev


.docker-client-env: &docker-client-env
    stage: release
    variables:
        WORKDIR: $CLIENT_WORKDIR
        DOCKER_IMAGE: $CI_REGISTRY_IMAGE/client

client dockerize:
    <<: *docker-client-env
    extends: .build docker
    only:
        refs:
            - master
            - staging

client dockerize dev:
    <<: *docker-client-env
    extends: .build docker dev